{% extends 'base.html' %}
{% load static %}

{% block title %}ì¢…í•©ì†Œë“ì„¸ ê³„ì‚° - ìŠ¤ë§ˆíŠ¸ ì‚¬ì—…ì ê°€ê³„ë¶€{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- í˜ì´ì§€ í—¤ë” -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>ğŸ“Š ì¢…í•©ì†Œë“ì„¸ ê³„ì‚°</h2>
        <a href="https://www.hometax.go.kr" target="_blank" class="btn btn-outline-primary btn-sm">
            ğŸ  í™ˆíƒìŠ¤ ë°”ë¡œê°€ê¸°
        </a>
    </div>

    <!-- ê³„ì‚° ì¡°ê±´ ì„ íƒ í¼ -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">ê³„ì‚° ì¡°ê±´</h5>
        </div>
        <div class="card-body">
            <form method="get" action="{% url 'tax:income_tax_report' %}">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label">{{ form.year.label }}</label>
                        {{ form.year }}
                        <small class="text-muted d-block">{{ form.year.help_text }}</small>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">{{ form.business_type.label }}</label>
                        {{ form.business_type }}
                        <small class="text-muted d-block">{{ form.business_type.help_text }}</small>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">{{ form.deduction_amount.label }}</label>
                        {{ form.deduction_amount }}
                        <small class="text-muted d-block">{{ form.deduction_amount.help_text }}</small>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">ê³„ì‚°í•˜ê¸°</button>
            </form>
        </div>
    </div>

    {% if not has_data %}
        <!-- ë°ì´í„° ì—†ìŒ -->
        <div class="alert alert-info">
            <h5>ğŸ“­ ê±°ë˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</h5>
            <p class="mb-0">{{ selected_year }}ë…„ ì‚¬ì—…ìš© ê±°ë˜ ë‚´ì—­ì„ ë¨¼ì € ë“±ë¡í•´ì£¼ì„¸ìš”.</p>
            <a href="{% url 'transactions:transaction_create' %}" class="btn btn-primary btn-sm mt-2">
                ê±°ë˜ ë“±ë¡í•˜ê¸°
            </a>
        </div>
    {% else %}

    <!-- 1. ê¸°ë³¸ ê³„ì‚° ê²°ê³¼ -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">ğŸ’° {{ selected_year }}ë…„ ì¢…í•©ì†Œë“ì„¸ ê³„ì‚°</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <table class="table table-borderless">
                        <tr>
                            <td class="text-muted">ì´ ìˆ˜ì… (ë§¤ì¶œ)</td>
                            <td class="text-end"><strong>{{ total_income|floatformat:0 }}ì›</strong></td>
                        </tr>
                        <tr>
                            <td class="text-muted">ì´ ì§€ì¶œ (ê²½ë¹„)</td>
                            <td class="text-end text-danger">-{{ total_expense|floatformat:0 }}ì›</td>
                        </tr>
                        <tr class="border-top">
                            <td class="text-muted">ì†Œë“ê¸ˆì•¡</td>
                            <td class="text-end"><strong>{{ actual_income_amount|floatformat:0 }}ì›</strong></td>
                        </tr>
                        <tr>
                            <td class="text-muted">ì†Œë“ê³µì œ</td>
                            <td class="text-end text-danger">-{{ deduction_amount|floatformat:0 }}ì›</td>
                        </tr>
                        <tr class="border-top">
                            <td class="text-muted"><strong>ê³¼ì„¸í‘œì¤€</strong></td>
                            <td class="text-end"><strong>{{ actual_taxable|floatformat:0 }}ì›</strong></td>
                        </tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <div class="bg-light p-4 rounded text-center">
                        <div class="text-muted mb-2">ì ìš© ì„¸ìœ¨</div>
                        <div class="display-6 text-primary mb-3">{{ actual_result.rate_percent }}%</div>
                        
                        <div class="text-muted mb-2">ì˜ˆìƒ ì„¸ê¸ˆ</div>
                        <div class="display-5 text-danger mb-2">{{ actual_result.total|floatformat:0 }}ì›</div>
                        
                        <small class="text-muted">
                            (ì†Œë“ì„¸ {{ actual_result.tax|floatformat:0 }}ì› + ì§€ë°©ì„¸ {{ actual_result.local_tax|floatformat:0 }}ì›)
                        </small>
                    </div>
                </div>
            </div>
            
            <div class="alert alert-info mt-3 mb-0">
                <small>
                    ğŸ“Œ <strong>ì‹¤ì œ ì§€ì¶œ ë°©ì‹</strong>ìœ¼ë¡œ ê³„ì‚°ëœ ê²°ê³¼ì…ë‹ˆë‹¤. 
                    (ê±°ë˜ ë‚´ì—­ {{ transaction_count }}ê±´ ë¶„ì„)
                </small>
            </div>
        </div>
    </div>

    <!-- 2. ë‹¨ìˆœê²½ë¹„ìœ¨ ë¹„êµ -->
    {% if simple_result %}
    <div class="card mb-4 border-success">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0">ğŸ’¡ ì ˆì„¸ ë°©ë²• ë¹„êµ</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <h6>â‘  ì‹¤ì œ ì§€ì¶œ ë°©ì‹</h6>
                    <p class="text-muted mb-2">ì¥ë¶€ì— ê¸°ë¡ëœ ì‹¤ì œ ì§€ì¶œ ì‚¬ìš©</p>
                    <div class="bg-light p-3 rounded">
                        <div>ê²½ë¹„: {{ total_expense|floatformat:0 }}ì›</div>
                        <div>ì†Œë“ê¸ˆì•¡: {{ actual_income_amount|floatformat:0 }}ì›</div>
                        <div class="mt-2 fs-5">
                            <strong>ì„¸ê¸ˆ: {{ actual_result.total|floatformat:0 }}ì›</strong>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <h6>â‘¡ ë‹¨ìˆœê²½ë¹„ìœ¨ ë°©ì‹ âœ…</h6>
                    <p class="text-muted mb-2">{{ simple_result.business_type_name }} ({{ simple_result.rate_percent }}%)</p>
                    <div class="bg-success bg-opacity-10 p-3 rounded border border-success">
                        <div>ì¸ì • ê²½ë¹„: {{ simple_result.expense|floatformat:0 }}ì›</div>
                        <div>ì†Œë“ê¸ˆì•¡: {{ simple_result.income_amount|floatformat:0 }}ì›</div>
                        <div class="mt-2 fs-5 text-success">
                            <strong>ì„¸ê¸ˆ: {{ simple_result.tax_result.total|floatformat:0 }}ì›</strong>
                        </div>
                    </div>
                </div>
            </div>
            
            {% if recommended == 'simple' %}
            <div class="alert alert-success mt-3 mb-0">
                <h6>ğŸ’° {{ savings|floatformat:0 }}ì› ì ˆì„¸ ê°€ëŠ¥!</h6>
                <p class="mb-0">ë‹¨ìˆœê²½ë¹„ìœ¨ ë°©ì‹ìœ¼ë¡œ ì‹ ê³ í•˜ë©´ ë” ìœ ë¦¬í•©ë‹ˆë‹¤.</p>
            </div>
            {% else %}
            <div class="alert alert-primary mt-3 mb-0">
                <h6>ğŸ“Š ì‹¤ì œ ì§€ì¶œ ë°©ì‹ ì¶”ì²œ</h6>
                <p class="mb-0">ì‹¤ì œ ì§€ì¶œ ë°©ì‹ì´ {{ savings|floatformat:0 }}ì› ë” ìœ ë¦¬í•©ë‹ˆë‹¤.</p>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- 3. ì¹´í…Œê³ ë¦¬ë³„ ì ˆì„¸ íš¨ê³¼ -->
    {% if category_impact %}
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">ğŸ“Š ì¹´í…Œê³ ë¦¬ë³„ ì ˆì„¸ íš¨ê³¼</h5>
        </div>
        <div class="card-body">
            <p class="text-muted mb-3">
                ê° ì¹´í…Œê³ ë¦¬ ì§€ì¶œì´ ì„¸ê¸ˆ ì ˆê°ì— ë¯¸ì¹˜ëŠ” ì˜í–¥ (ì„¸ìœ¨ {{ actual_result.rate_percent }}% ì ìš©)
            </p>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>ì¹´í…Œê³ ë¦¬</th>
                            <th class="text-end">ì§€ì¶œì•¡</th>
                            <th class="text-end">ì ˆì„¸ íš¨ê³¼</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in category_impact %}
                        <tr>
                            <td>{{ item.category }}</td>
                            <td class="text-end">{{ item.amount|floatformat:0 }}ì›</td>
                            <td class="text-end text-success">
                                <strong>{{ item.tax_saved|floatformat:0 }}ì›</strong>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- 4. ì›”ë³„ ëˆ„ì  ì¶”ì´ -->
    {% if monthly_data %}
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">ğŸ“ˆ ì›”ë³„ ëˆ„ì  ì„¸ê¸ˆ ì¶”ì´</h5>
        </div>
        <div class="card-body">
            <p class="text-muted mb-3">
                ë§¤ì›” ëˆ„ì  ì†Œë“ ê¸°ì¤€ ì˜ˆìƒ ì„¸ê¸ˆ
            </p>
            <div class="table-responsive">
                <table class="table table-sm table-hover">
                    <thead>
                        <tr>
                            <th>ì›”</th>
                            <th class="text-end">ëˆ„ì  ì†Œë“ê¸ˆì•¡</th>
                            <th class="text-end">ì˜ˆìƒ ì„¸ê¸ˆ</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for m in monthly_data %}
                        <tr {% if m.month == 12 %}class="table-active"{% endif %}>
                            <td>{{ m.month }}ì›”</td>
                            <td class="text-end">{{ m.income|floatformat:0 }}ì›</td>
                            <td class="text-end">{{ m.tax|floatformat:0 }}ì›</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            {% if monthly_data|length == 12 %}
            <div class="alert alert-info mb-0 mt-3">
                <small>
                    ğŸ’¡ í˜„ì¬ ì§„í–‰ë¥ ë¡œ ê°€ë©´ ì—°ë§ ì˜ˆìƒ ì„¸ê¸ˆì€ <strong>ì•½ {{ last_month_tax|floatformat:0 }}ì›</strong>ì…ë‹ˆë‹¤.
                </small>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- 5. ì„¸ìœ¨ êµ¬ê°„ ì •ë³´ -->
    {% if bracket_info %}
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">ğŸ“Œ ì„¸ìœ¨ êµ¬ê°„ ì •ë³´</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="bg-light p-3 rounded">
                        <div class="text-muted mb-2">í˜„ì¬ ìœ„ì¹˜</div>
                        <div class="fs-4">
                            <strong>{{ actual_taxable|floatformat:0 }}ì›</strong>
                        </div>
                        <div class="text-primary">
                            ì„¸ìœ¨ {{ bracket_info.current_rate_percent }}% êµ¬ê°„
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    {% if bracket_info.is_max %}
                    <div class="bg-warning bg-opacity-10 p-3 rounded">
                        <div class="text-muted mb-2">ìµœê³  ì„¸ìœ¨ êµ¬ê°„</div>
                        <div class="fs-4">
                            <strong>{{ bracket_info.current_rate_percent }}%</strong>
                        </div>
                        <div class="text-muted">
                            ìµœê³  ì„¸ìœ¨ì´ ì ìš©ë˜ê³  ìˆìŠµë‹ˆë‹¤
                        </div>
                    </div>
                    {% else %}
                    <div class="bg-info bg-opacity-10 p-3 rounded">
                        <div class="text-muted mb-2">ë‹¤ìŒ êµ¬ê°„ê¹Œì§€</div>
                        <div class="fs-4">
                            <strong>{{ bracket_info.distance|floatformat:0 }}ì›</strong>
                        </div>
                        <div class="text-muted">
                            ë‚¨ìŒ ({{ bracket_info.next_rate_percent }}% êµ¬ê°„)
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            {% if not bracket_info.is_max %}
            <div class="alert alert-info mt-3 mb-0">
                <small>
                    ğŸ’¡ ì†Œë“ì´ <strong>{{ bracket_info.distance|floatformat:0 }}ì›</strong> ë” ëŠ˜ì–´ë‚˜ë©´ 
                    ì„¸ìœ¨ì´ <strong>{{ bracket_info.current_rate_percent }}% â†’ {{ bracket_info.next_rate_percent }}%</strong>ë¡œ ì˜¬ë¼ê°‘ë‹ˆë‹¤.
                </small>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

  

    <!-- 7. 2024ë…„ ì¢…í•©ì†Œë“ì„¸ ì„¸ìœ¨í‘œ -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">ğŸ“‹ {{ selected_year }}ë…„ ì¢…í•©ì†Œë“ì„¸ ì„¸ìœ¨í‘œ</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead class="table-light">
                        <tr>
                            <th>ê³¼ì„¸í‘œì¤€</th>
                            <th class="text-center">ì„¸ìœ¨</th>
                            <th class="text-end">ëˆ„ì§„ê³µì œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>1,400ë§Œì› ì´í•˜</td>
                            <td class="text-center">6%</td>
                            <td class="text-end">-</td>
                        </tr>
                        <tr>
                            <td>1,400ë§Œì› ì´ˆê³¼ ~ 5,000ë§Œì›</td>
                            <td class="text-center">15%</td>
                            <td class="text-end">126ë§Œì›</td>
                        </tr>
                        <tr>
                            <td>5,000ë§Œì› ì´ˆê³¼ ~ 8,800ë§Œì›</td>
                            <td class="text-center">24%</td>
                            <td class="text-end">576ë§Œì›</td>
                        </tr>
                        <tr>
                            <td>8,800ë§Œì› ì´ˆê³¼ ~ 1.5ì–µì›</td>
                            <td class="text-center">35%</td>
                            <td class="text-end">1,544ë§Œì›</td>
                        </tr>
                        <tr>
                            <td>1.5ì–µì› ì´ˆê³¼ ~ 3ì–µì›</td>
                            <td class="text-center">38%</td>
                            <td class="text-end">1,994ë§Œì›</td>
                        </tr>
                        <tr>
                            <td>3ì–µì› ì´ˆê³¼ ~ 5ì–µì›</td>
                            <td class="text-center">40%</td>
                            <td class="text-end">2,594ë§Œì›</td>
                        </tr>
                        <tr>
                            <td>5ì–µì› ì´ˆê³¼ ~ 10ì–µì›</td>
                            <td class="text-center">42%</td>
                            <td class="text-end">3,594ë§Œì›</td>
                        </tr>
                        <tr>
                            <td>10ì–µì› ì´ˆê³¼</td>
                            <td class="text-center">45%</td>
                            <td class="text-end">6,594ë§Œì›</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <small class="text-muted">
                * ì§€ë°©ì†Œë“ì„¸(ì†Œë“ì„¸ì˜ 10%)ê°€ ë³„ë„ë¡œ ë¶€ê³¼ë©ë‹ˆë‹¤.
            </small>
        </div>
    </div>

    {% endif %}

    <!-- ë²•ì  ê³ ì§€ -->
    <div class="alert alert-warning">
        <h6>âš ï¸ ì¤‘ìš” ì•ˆë‚´</h6>
        <ul class="mb-0">
            <li>ì´ ê³„ì‚° ê²°ê³¼ëŠ” <strong>ì°¸ê³ ìš©</strong>ìœ¼ë¡œë§Œ ì‚¬ìš©í•´ì£¼ì„¸ìš”.</li>
            <li>ì‹¤ì œ ì„¸ì•¡ì€ ì†Œë“ê³µì œ, ì„¸ì•¡ê³µì œ, ê¸°íƒ€ ìš”ì¸ì— ë”°ë¼ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
            <li>ì •í™•í•œ ì‹ ê³ ëŠ” <a href="https://www.hometax.go.kr" target="_blank" class="alert-link">í™ˆíƒìŠ¤</a>ë¥¼ ì´ìš©í•˜ê±°ë‚˜ ì„¸ë¬´ì‚¬ì™€ ìƒë‹´í•˜ì„¸ìš”.</li>
            <li>ë³¸ ì„œë¹„ìŠ¤ëŠ” ê³„ì‚° ì˜¤ë¥˜ë‚˜ ì‹ ê³  ê²°ê³¼ì— ëŒ€í•œ ì±…ì„ì„ ì§€ì§€ ì•ŠìŠµë‹ˆë‹¤.</li>
        </ul>
    </div>
</div>

<script>
    // í¼ í•„ë“œì— í´ë˜ìŠ¤ ì¶”ê°€
    document.addEventListener('DOMContentLoaded', function () {
        const formInputs = document.querySelectorAll('input, select, textarea');
        formInputs.forEach(input => {
            if (!input.classList.contains('form-control') && 
                !input.classList.contains('form-select') &&
                !input.classList.contains('form-check-input')) {
                if (input.type === 'checkbox') {
                    input.classList.add('form-check-input');
                } else if (input.tagName === 'SELECT') {
                    input.classList.add('form-select');
                } else {
                    input.classList.add('form-control');
                }
            }
        });
    });
</script>

{% endblock %}