{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block content %}
<div class="content-wrapper">
    <!-- í˜ì´ì§€ í—¤ë” -->
    <div class="welcome-header">
        <div class="welcome-icon">ğŸ“Š</div>
        <h1 class="page-title">{{ year }}ë…„ {{ quarter }}ë¶„ê¸° ë¶€ê°€ì„¸ ì‹ ê³  ì¤€ë¹„</h1>
        <p class="text-muted">{{ start_date|date:"Y-m-d" }} ~ {{ end_date|date:"Y-m-d" }}</p>
    </div>

    <!-- ì„¸ê¸ˆ ìš”ì•½ ì„¹ì…˜ -->
    <div class="dashboard-section mb-4">
        <div class="section-header">
            <span class="section-icon">ğŸ’°</span>
            <h2 class="section-title">ì„¸ê¸ˆ ìš”ì•½</h2>
        </div>
        <div class="summary-card">
            <div class="summary-grid">
                <div class="summary-item">
                    <span class="summary-label">ë§¤ì¶œì„¸ì•¡ (ë‚©ë¶€)</span>
                    <span class="summary-value income">{{ sales.total_sales_vat|default:0|floatformat:0|intcomma }}ì›</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">ë§¤ì…ì„¸ì•¡ (ê³µì œ)</span>
                    <span class="summary-value expense">{{ purchase.total_purchase_vat|default:0|floatformat:0|intcomma }}ì›</span>
                </div>
                <div class="summary-item" style="border-left: 3px solid var(--secondary-blue);">
                    <span class="summary-label">ì˜ˆìƒ ë‚©ë¶€ì„¸ì•¡</span>
                    <span class="summary-value profit">{{ estimated_tax|floatformat:0|intcomma }}ì›</span>
                </div>
            </div>
        </div>
    </div>

    <!-- ë¶€ê°€ì„¸ ìƒì„¸ í˜„í™© ì„¹ì…˜ -->
    <div class="dashboard-section mb-4">
        <div class="section-header">
            <span class="section-icon">ğŸ“…</span>
            <h2 class="section-title">ë¶€ê°€ì„¸ ìƒì„¸ í˜„í™©</h2>
        </div>

        <!-- 2ë‹¨ íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
        <div class="vat-tabs-wrapper">
            <!-- 1ë‹¨: ë¶„ê¸° ì„ íƒ -->
            <div class="vat-tabs quarter-tabs">
                <a href="?year={{ year }}&quarter=1" class="vat-tab-btn {% if quarter == 1 %}active{% endif %}">
                    <span class="tab-icon">1ï¸âƒ£</span>
                    <span class="tab-text">1ë¶„ê¸°</span>
                </a>
                <a href="?year={{ year }}&quarter=2" class="vat-tab-btn {% if quarter == 2 %}active{% endif %}">
                    <span class="tab-icon">2ï¸âƒ£</span>
                    <span class="tab-text">2ë¶„ê¸°</span>
                </a>
                <a href="?year={{ year }}&quarter=3" class="vat-tab-btn {% if quarter == 3 %}active{% endif %}">
                    <span class="tab-icon">3ï¸âƒ£</span>
                    <span class="tab-text">3ë¶„ê¸°</span>
                </a>
                <a href="?year={{ year }}&quarter=4" class="vat-tab-btn {% if quarter == 4 %}active{% endif %}">
                    <span class="tab-icon">4ï¸âƒ£</span>
                    <span class="tab-text">4ë¶„ê¸°</span>
                </a>
            </div>

            <!-- 2ë‹¨: ì›” ì„ íƒ (ì„ íƒëœ ë¶„ê¸°ì˜ ì›”ë“¤) -->
            <div class="vat-tabs month-tabs">
                <a href="?year={{ year }}&quarter={{ quarter }}" class="vat-tab-btn {% if not month %}active{% endif %}">
                    <span class="tab-icon">ğŸ“Š</span>
                    <span class="tab-text">ë¶„ê¸° ì „ì²´</span>
                </a>
                {% for stat in monthly_stats %}
                <a href="?year={{ year }}&quarter={{ quarter }}&month={{ stat.month }}" class="vat-tab-btn {% if month == stat.month %}active{% endif %}">
                    <span class="tab-icon">ğŸ“…</span>
                    <span class="tab-text">{{ stat.month }}ì›”</span>
                </a>
                {% endfor %}
            </div>
        </div>

        <!-- ì„ íƒëœ ë·°ì— ë”°ë¥¸ ë‚´ìš© í‘œì‹œ -->
        {% if not month %}
        <!-- ë¶„ê¸° ì „ì²´ ë·° -->
        <div class="table-wrapper">
            <table class="transaction-table">
                <thead>
                    <tr>
                        <th>ì›”</th>
                        <th>ë§¤ì¶œì„¸ì•¡(ë‚©ë¶€)</th>
                        <th>ë§¤ì…ì„¸ì•¡(ê³µì œ)</th>
                        <th>ì˜ˆìƒ ë‚©ë¶€ì„¸ì•¡</th>
                    </tr>
                </thead>
                <tbody>
                    {% for stat in monthly_stats %}
                    <tr>
                        <td>{{ stat.month }}ì›”</td>
                        <td class="amount income">{{ stat.sales_vat|floatformat:0|intcomma }}ì›</td>
                        <td class="amount expense">{{ stat.purchase_vat|floatformat:0|intcomma }}ì›</td>
                        <td class="amount" style="font-weight: 700;">{{ stat.net_vat|floatformat:0|intcomma }}ì›</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4" class="text-center" style="color: var(--gray-500);">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <!-- íŠ¹ì • ì›” ìƒì„¸ ë·° -->
        {% for stat in monthly_stats %}
            {% if stat.month == month %}
            <div class="summary-card" style="margin-bottom: var(--spacing-lg);">
                <h3 class="summary-title">{{ stat.month }}ì›” ìš”ì•½</h3>
                <div class="summary-grid">
                    <div class="summary-item">
                        <span class="summary-label">ë§¤ì¶œì„¸ì•¡</span>
                        <span class="summary-value income">{{ stat.sales_vat|floatformat:0|intcomma }}ì›</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">ë§¤ì…ì„¸ì•¡</span>
                        <span class="summary-value expense">{{ stat.purchase_vat|floatformat:0|intcomma }}ì›</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">ìˆœì„¸ì•¡</span>
                        <span class="summary-value profit">{{ stat.net_vat|floatformat:0|intcomma }}ì›</span>
                    </div>
                </div>
            </div>
            {% endif %}
        {% endfor %}
        {% endif %}
    </div>

    <!-- ê³¼ì„¸ ê±°ë˜ ìƒì„¸ ë‚´ì—­ ì„¹ì…˜ (í˜ì´ì§€ë„¤ì´ì…˜ ì ìš©) -->
    <div class="transactions-section">
        <div class="section-header">
            <span class="section-icon">ğŸ“</span>
            <h2 class="section-title">
                ê³¼ì„¸ ê±°ë˜ ìƒì„¸ ë‚´ì—­ 
                {% if month %}({{ month }}ì›”){% else %}(ì „ì²´){% endif %}
            </h2>
        </div>
        <div class="table-wrapper">
            <table class="transaction-table">
                <thead>
                    <tr>
                        <th>ë‚ ì§œ</th>
                        <th>ê±°ë˜ì²˜</th>
                        <th>êµ¬ë¶„</th>
                        <th>ì¦ë¹™</th>
                        <th>ê³µê¸‰ê°€ì•¡</th>
                        <th>ë¶€ê°€ì„¸</th>
                        <th>í•©ê³„</th>
                    </tr>
                </thead>
                <tbody>
                    {% for tx in page_obj %}
                    <tr>
                        <td>{{ tx.occurred_at|date:"Y-m-d" }}</td>
                        <td>{{ tx.get_merchant_display }}</td>
                        <td>
                            <span class="badge {% if tx.tx_type == 'IN' %}badge-income{% else %}badge-expense{% endif %}">
                                {{ tx.get_tx_type_display }}
                            </span>
                        </td>
                        <td class="text-center">
                            {% if tx.has_attachment %}
                                <a href="{{ tx.attachment.file.url }}" target="_blank" title="ì¦ë¹™ ë³´ê¸°">
                                    <span style="color: #2c3e50; font-weight: bold; cursor: pointer;">ğŸ“„</span>
                                </a>
                            {% else %}
                                <span style="opacity: 0.2;" title="ì¦ë¹™ ì—†ìŒ">ğŸ“„</span>
                            {% endif %}
                        </td>
                        <td>{{ tx.supply_value|floatformat:0|intcomma }}ì›</td>
                        <td class="amount {% if tx.tx_type == 'IN' %}income{% else %}expense{% endif %}">
                            {{ tx.vat_amount|floatformat:0|intcomma }}ì›
                        </td>
                        <td style="font-weight: 700;">{{ tx.amount|floatformat:0|intcomma }}ì›</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="text-center" style="color: var(--gray-500);">
                            í•´ë‹¹ ê¸°ê°„ì˜ ê³¼ì„¸ ê±°ë˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
        {% if page_obj.has_other_pages %}
        <div class="pagination-wrapper">
            <div class="pagination">
                <span class="page-current">
                    {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}
                </span>
                
                {% if page_obj.has_previous %}
                <a href="?year={{ year }}&quarter={{ quarter }}{% if month %}&month={{ month }}{% endif %}&page=1" class="page-link">ì²˜ìŒ</a>
                <a href="?year={{ year }}&quarter={{ quarter }}{% if month %}&month={{ month }}{% endif %}&page={{ page_obj.previous_page_number }}" class="page-link">ì´ì „</a>
                {% endif %}

                {% if page_obj.has_next %}
                <a href="?year={{ year }}&quarter={{ quarter }}{% if month %}&month={{ month }}{% endif %}&page={{ page_obj.next_page_number }}" class="page-link">ë‹¤ìŒ</a>
                <a href="?year={{ year }}&quarter={{ quarter }}{% if month %}&month={{ month }}{% endif %}&page={{ page_obj.paginator.num_pages }}" class="page-link">ë§ˆì§€ë§‰</a>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<style>
/* VAT íƒ­ ë˜í¼ */
.vat-tabs-wrapper {
    margin-bottom: var(--spacing-lg);
}

/* íƒ­ ê³µí†µ ìŠ¤íƒ€ì¼ */
.vat-tabs {
    display: flex;
    gap: var(--spacing-xs);
    flex-wrap: wrap;
    padding: var(--spacing-sm);
    background: var(--gray-50);
    border-radius: var(--radius-md);
}

/* ë¶„ê¸° íƒ­ (1ë‹¨) */
.quarter-tabs {
    margin-bottom: var(--spacing-xs);
}

/* ì›” íƒ­ (2ë‹¨) */
.month-tabs {
    border-top: 2px solid var(--gray-200);
    padding-top: var(--spacing-sm);
}

.vat-tab-btn {
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
    padding: var(--spacing-sm) var(--spacing-md);
    border: 2px solid transparent;
    background: var(--white);
    border-radius: var(--radius-sm);
    text-decoration: none;
    font-weight: 600;
    color: var(--gray-700);
    transition: var(--transition);
    box-shadow: var(--shadow-sm);
}

.vat-tab-btn:hover {
    background: var(--primary-yellow-light);
    border-color: var(--primary-yellow);
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.vat-tab-btn.active {
    background: linear-gradient(135deg, var(--primary-yellow) 0%, var(--primary-yellow-dark) 100%);
    color: var(--gray-900);
    font-weight: 700;
    border-color: var(--primary-yellow-dark);
    box-shadow: var(--shadow-md);
}

.tab-icon {
    font-size: 1.125rem;
}

.tab-text {
    font-size: 0.9375rem;
}

/* í˜ì´ì§€ë„¤ì´ì…˜ ìŠ¤íƒ€ì¼ */
.pagination-wrapper {
    display: flex;
    justify-content: center;
    margin-top: var(--spacing-lg);
}

.pagination {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
}

.page-link {
    padding: var(--spacing-sm) var(--spacing-md);
    background: var(--white);
    border: 2px solid var(--primary-yellow);
    border-radius: var(--radius-sm);
    text-decoration: none;
    color: var(--gray-800);
    font-weight: 600;
    transition: var(--transition);
}

.page-link:hover {
    background: var(--primary-yellow-light);
    transform: translateY(-2px);
}

.page-current {
    padding: var(--spacing-sm) var(--spacing-md);
    background: linear-gradient(135deg, var(--primary-yellow) 0%, var(--primary-yellow-dark) 100%);
    border-radius: var(--radius-sm);
    font-weight: 700;
    color: var(--gray-900);
}

/* ì¶”ê°€ ìœ í‹¸ë¦¬í‹° */
.mb-4 {
    margin-bottom: var(--spacing-xl);
}

.text-center {
    text-align: center;
}

.text-muted {
    color: var(--gray-500);
    font-size: 1rem;
}

/* ë°˜ì‘í˜• */
@media (max-width: 768px) {
    .vat-tabs {
        flex-direction: column;
    }
    
    .vat-tab-btn {
        width: 100%;
        justify-content: center;
    }
    
    .pagination {
        flex-wrap: wrap;
    }
}
</style>
{% endblock %}