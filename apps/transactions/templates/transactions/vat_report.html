{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block content %}
<div class="content-wrapper">
    <!-- í˜ì´ì§€ í—¤ë” -->
    <div class="welcome-header">
        <div class="welcome-icon">ğŸ“Š</div>
        <h1 class="page-title">{{ year }}ë…„ {{ quarter }}ë¶„ê¸° ë¶€ê°€ì„¸ ì‹ ê³  ì¤€ë¹„</h1>
        <p class="text-muted">{{ start_date|date:"Y-m-d" }} ~ {{ end_date|date:"Y-m-d" }}</p>
    </div>

    <!-- ì„¸ê¸ˆ ìš”ì•½ ì„¹ì…˜ -->
    <div class="dashboard-section mb-4">
        <div class="section-header">
            <span class="section-icon">ğŸ’°</span>
            <h2 class="section-title">ì„¸ê¸ˆ ìš”ì•½</h2>
        </div>
        <div class="summary-card">
            <div class="summary-grid">
                <div class="summary-item">
                    <span class="summary-label">ë§¤ì¶œì„¸ì•¡ (ë‚©ë¶€)</span>
                    <span class="summary-value income">{{ sales.total_sales_vat|default:0|floatformat:0|intcomma }}ì›</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">ë§¤ì…ì„¸ì•¡ (ê³µì œ)</span>
                    <span class="summary-value expense">{{ purchase.total_purchase_vat|default:0|floatformat:0|intcomma }}ì›</span>
                </div>
                <div class="summary-item" style="border-left: 3px solid var(--secondary-blue);">
                    <span class="summary-label">ì˜ˆìƒ ë‚©ë¶€ì„¸ì•¡</span>
                    <span class="summary-value profit">{{ estimated_tax|floatformat:0|intcomma }}ì›</span>
                </div>
            </div>
        </div>
    </div>

    <!-- ì›”ë³„/ë¶„ê¸°ë³„ ë¶€ê°€ì„¸ í˜„í™© ì„¹ì…˜ -->
    <div class="dashboard-section mb-4">
        <div class="section-header">
            <span class="section-icon">ğŸ“…</span>
            <h2 class="section-title">ë¶€ê°€ì„¸ ìƒì„¸ í˜„í™©</h2>
        </div>

        <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
        <div class="vat-tabs">
            <button class="vat-tab-btn active" onclick="showVatView('quarter')">
                <span class="tab-icon">ğŸ“Š</span>
                <span class="tab-text">ë¶„ê¸° ì „ì²´</span>
            </button>
            {% for stat in monthly_stats %}
            <button class="vat-tab-btn" onclick="showVatView('month-{{ stat.month }}')">
                <span class="tab-icon">ğŸ“…</span>
                <span class="tab-text">{{ stat.month }}ì›”</span>
            </button>
            {% endfor %}
        </div>

        <!-- ë¶„ê¸° ì „ì²´ ë·° -->
        <div class="vat-view-content active" id="vat-view-quarter">
            <div class="table-wrapper">
                <table class="transaction-table">
                    <thead>
                        <tr>
                            <th>ì›”</th>
                            <th>ë§¤ì¶œì„¸ì•¡(ë‚©ë¶€)</th>
                            <th>ë§¤ì…ì„¸ì•¡(ê³µì œ)</th>
                            <th>ì˜ˆìƒ ë‚©ë¶€ì„¸ì•¡</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for stat in monthly_stats %}
                        <tr>
                            <td>{{ stat.month }}ì›”</td>
                            <td class="amount income">{{ stat.sales_vat|floatformat:0|intcomma }}ì›</td>
                            <td class="amount expense">{{ stat.purchase_vat|floatformat:0|intcomma }}ì›</td>
                            <td class="amount" style="font-weight: 700;">{{ stat.net_vat|floatformat:0|intcomma }}ì›</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="4" class="text-center" style="color: var(--gray-500);">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ê° ì›”ë³„ ìƒì„¸ ë·° -->
        {% for stat in monthly_stats %}
        <div class="vat-view-content" id="vat-view-month-{{ stat.month }}">
            <!-- ì›”ë³„ ìš”ì•½ ì¹´ë“œ -->
            <div class="summary-card" style="margin-bottom: var(--spacing-lg);">
                <h3 class="summary-title">{{ stat.month }}ì›” ìš”ì•½</h3>
                <div class="summary-grid">
                    <div class="summary-item">
                        <span class="summary-label">ë§¤ì¶œì„¸ì•¡</span>
                        <span class="summary-value income">{{ stat.sales_vat|floatformat:0|intcomma }}ì›</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">ë§¤ì…ì„¸ì•¡</span>
                        <span class="summary-value expense">{{ stat.purchase_vat|floatformat:0|intcomma }}ì›</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">ìˆœì„¸ì•¡</span>
                        <span class="summary-value profit">{{ stat.net_vat|floatformat:0|intcomma }}ì›</span>
                    </div>
                </div>
            </div>

            <!-- ì›”ë³„ ê±°ë˜ ë‚´ì—­ -->
            <div class="table-wrapper">
                <table class="transaction-table">
                    <thead>
                        <tr>
                            <th>ë‚ ì§œ</th>
                            <th>ê±°ë˜ì²˜</th>
                            <th>êµ¬ë¶„</th>
                            <th>ì¦ë¹™</th>
                            <th>ê³µê¸‰ê°€ì•¡</th>
                            <th>ë¶€ê°€ì„¸</th>
                            <th>í•©ê³„</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for tx in transaction_list %}
                            {% if tx.occurred_at.month == stat.month %}
                            <tr>
                                <td>{{ tx.occurred_at|date:"Y-m-d" }}</td>
                                <td>{{ tx.get_merchant_display }}</td>
                                <td>
                                    <span class="badge {% if tx.tx_type == 'IN' %}badge-income{% else %}badge-expense{% endif %}">
                                        {{ tx.get_tx_type_display }}
                                    </span>
                                </td>
                                <td>
                                    {% if tx.has_attachment %}
                                        <span title="ì¦ë¹™ ìˆìŒ" style="cursor:pointer;">ğŸ“„</span>
                                        {# ë‚˜ì¤‘ì— í´ë¦­ ì‹œ íŒŒì¼ì„ ë³´ì—¬ì£¼ëŠ” ëª¨ë‹¬ì´ë‚˜ ë§í¬ë¥¼ ì—°ê²°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤ #}
                                    {% else %}
                                        <span class="text-muted" title="ì¦ë¹™ ì—†ìŒ" style="opacity: 0.3;">ğŸ“„</span>
                                    {% endif %}
                                </td>
                                <td>{{ tx.supply_value|floatformat:0|intcomma }}ì›</td>
                                <td class="amount {% if tx.tx_type == 'IN' %}income{% else %}expense{% endif %}">
                                    {{ tx.vat_amount|floatformat:0|intcomma }}ì›
                                </td>
                                <td style="font-weight: 700;">{{ tx.amount|floatformat:0|intcomma }}ì›</td>
                            </tr>
                            {% endif %}
                        {% empty %}
                            <tr>
                                <td colspan="7" class="text-center" style="color: var(--gray-500);">{{ stat.month }}ì›” ê±°ë˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- ê³¼ì„¸ ê±°ë˜ ì „ì²´ ë‚´ì—­ ì„¹ì…˜ -->
    <div class="transactions-section">
        <div class="section-header">
            <span class="section-icon">ğŸ“</span>
            <h2 class="section-title">ê³¼ì„¸ ê±°ë˜ ìƒì„¸ ë‚´ì—­ (ì „ì²´)</h2>
        </div>
        <div class="table-wrapper">
            <table class="transaction-table">
                <thead>
                    <tr>
                        <th>ë‚ ì§œ</th>
                        <th>ê±°ë˜ì²˜</th>
                        <th>êµ¬ë¶„</th>
                        <th>ì¦ë¹™</th>
                        <th>ê³µê¸‰ê°€ì•¡</th>
                        <th>ë¶€ê°€ì„¸</th>
                        <th>í•©ê³„</th>
                    </tr>
                </thead>
                <tbody>
                    {% for tx in transaction_list %}
                    <tr>
                        <td>{{ tx.occurred_at|date:"Y-m-d" }}</td>
                        <td>{{ tx.get_merchant_display }}</td>
                        <td>
                            <span class="badge {% if tx.tx_type == 'IN' %}badge-income{% else %}badge-expense{% endif %}">
                                {{ tx.get_tx_type_display }}
                            </span>
                        </td>
                        <td class="text-center">
                            {% if tx.has_attachment %}
                                <a href="{{ tx.attachment.file.url }}" target="_blank" title="ì¦ë¹™ ë³´ê¸°">
                                    <span style="color: #2c3e50; font-weight: bold; cursor: pointer;">ğŸ“„ì¦ë¹™ìë£Œ</span>
                                </a>
                            {% else %}
                                <span style="opacity: 0.2;" title="ì¦ë¹™ ì—†ìŒ">ğŸ“„</span>
                            {% endif %}
                        </td>
                        <td>{{ tx.supply_value|floatformat:0|intcomma }}ì›</td>
                        <td class="amount {% if tx.tx_type == 'IN' %}income{% else %}expense{% endif %}">
                            {{ tx.vat_amount|floatformat:0|intcomma }}ì›
                        </td>
                        <td style="font-weight: 700;">{{ tx.amount|floatformat:0|intcomma }}ì›</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="text-center" style="color: var(--gray-500);">í•´ë‹¹ ê¸°ê°„ì˜ ê³¼ì„¸ ê±°ë˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- ë¶„ê¸° ì„ íƒ ë²„íŠ¼ -->
    <div class="cta-section mt-4">
        <div class="button-group">
            <a href="?year={{ year }}&quarter=1" class="btn {% if quarter == 1 %}btn-primary{% else %}btn-secondary{% endif %}">1ë¶„ê¸°</a>
            <a href="?year={{ year }}&quarter=2" class="btn {% if quarter == 2 %}btn-primary{% else %}btn-secondary{% endif %}">2ë¶„ê¸°</a>
            <a href="?year={{ year }}&quarter=3" class="btn {% if quarter == 3 %}btn-primary{% else %}btn-secondary{% endif %}">3ë¶„ê¸°</a>
            <a href="?year={{ year }}&quarter=4" class="btn {% if quarter == 4 %}btn-primary{% else %}btn-secondary{% endif %}">4ë¶„ê¸°</a>
        </div>
    </div>
</div>

<style>
/* VAT ë¦¬í¬íŠ¸ ì „ìš© íƒ­ ìŠ¤íƒ€ì¼ */
.vat-tabs {
    display: flex;
    gap: var(--spacing-xs);
    flex-wrap: wrap;
    margin-bottom: var(--spacing-lg);
    padding: var(--spacing-sm);
    background: var(--gray-50);
    border-radius: var(--radius-md);
}

.vat-tab-btn {
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
    padding: var(--spacing-sm) var(--spacing-md);
    border: 2px solid transparent;
    background: var(--white);
    border-radius: var(--radius-sm);
    cursor: pointer;
    font-weight: 600;
    color: var(--gray-700);
    transition: var(--transition);
    box-shadow: var(--shadow-sm);
}

.vat-tab-btn:hover {
    background: var(--primary-yellow-light);
    border-color: var(--primary-yellow);
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.vat-tab-btn.active {
    background: linear-gradient(135deg, var(--primary-yellow) 0%, var(--primary-yellow-dark) 100%);
    color: var(--gray-900);
    font-weight: 700;
    border-color: var(--primary-yellow-dark);
    box-shadow: var(--shadow-md);
}

.tab-icon {
    font-size: 1.125rem;
}

.tab-text {
    font-size: 0.9375rem;
}

.vat-view-content {
    display: none;
    animation: fadeIn 0.4s ease-out;
}

.vat-view-content.active {
    display: block;
}

/* ì¶”ê°€ ìœ í‹¸ë¦¬í‹° */
.mb-4 {
    margin-bottom: var(--spacing-xl);
}

.mt-4 {
    margin-top: var(--spacing-xl);
}

.text-center {
    text-align: center;
}

.text-muted {
    color: var(--gray-500);
    font-size: 1rem;
}

@media (max-width: 768px) {
    .vat-tabs {
        flex-direction: column;
    }
    
    .vat-tab-btn {
        width: 100%;
        justify-content: center;
    }
}
</style>

<script>
function showVatView(viewId) {
    // ëª¨ë“  íƒ­ ë²„íŠ¼ ë¹„í™œì„±í™”
    document.querySelectorAll('.vat-tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // ëª¨ë“  ì»¨í…ì¸  ìˆ¨ê¸°ê¸°
    document.querySelectorAll('.vat-view-content').forEach(content => {
        content.classList.remove('active');
    });
    
    // í´ë¦­ëœ íƒ­ ë²„íŠ¼ í™œì„±í™”
    event.target.closest('.vat-tab-btn').classList.add('active');
    
    // ì„ íƒëœ ì»¨í…ì¸  í‘œì‹œ
    document.getElementById('vat-view-' + viewId).classList.add('active');
}
</script>
{% endblock %}